---
import CollegeLayout from "@/layouts/CollegeLayout.astro";
import { ArrowLeft, ArrowRight } from "lucide-react";

// Define the FormattedPost type locally since we're server-side only
interface FormattedPost {
  id: string;
  title: string;
  excerpt: string;
  content: string;
  date: string;
  year: string;
  category: string;
  image?: string | null;
  permalink: string;
  likes: number;
  comments: number;
  shares: number;
}

let posts: FormattedPost[] = [];
let hasMore = false;
let nextCursor: string | undefined;
let error: string | null = null;

// Fetch Facebook posts on the server
try {
    const pageId = import.meta.env.FACEBOOK_PAGE_ID;
    const accessToken = import.meta.env.FACEBOOK_ACCESS_TOKEN;

    if (pageId && accessToken) {
        // Fetch posts directly from Facebook Graph API
        const response = await fetch(
            `https://graph.facebook.com/v18.0/${pageId}/feed?fields=message,story,created_time,full_picture,picture,permalink_url,likes.summary(true),comments.summary(true),shares&limit=5&access_token=${accessToken}`
        );

        if (response.ok) {
            const fbData = await response.json();
            console.log('Server: Facebook posts fetched:', fbData);

            // Transform Facebook data to our format
            posts = fbData.data ? fbData.data.map((post: any) => {
                const createdDate = new Date(post.created_time);
                const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

                const content = post.message || post.story || "";
                const title = content.split('.')[0].trim() || 'Facebook Post';
                const excerpt = content.substring(0, 200) + (content.length > 200 ? "..." : "");

                return {
                    id: post.id,
                    title: title,
                    excerpt: excerpt,
                    content: content || "No content available.",
                    date: `${monthNames[createdDate.getMonth()]} ${createdDate.getDate()}`,
                    year: createdDate.getFullYear().toString(),
                    category: "General News",
                    image: post.full_picture || post.picture,
                    permalink: post.permalink_url,
                    likes: post.likes?.summary?.total_count || 0,
                    comments: post.comments?.summary?.total_count || 0,
                    shares: post.shares?.count || 0,
                };
            }) : [];

            hasMore = !!fbData.paging?.next;
            nextCursor = fbData.paging?.cursors?.after;
        } else {
            throw new Error(`Facebook API error: ${response.status}`);
        }
    } else {
        // Fallback posts if no API credentials
        posts = [
            {
                id: "sample-1",
                date: "DEC",
                year: "2024",
                title: "Students Win National Science Competition",
                category: "Achievements",
                excerpt: "Our talented science team has achieved remarkable success at the National STEM Challenge.",
                content: "Our talented science team has achieved remarkable success at the National STEM Challenge.",
                permalink: "#",
                likes: 45,
                comments: 12,
                shares: 8,
                image: "/placeholder.svg"
            },
            {
                id: "sample-2",
                date: "DEC",
                year: "2024",
                title: "New STEM Lab Opens with State-of-the-Art Equipment",
                category: "Campus News",
                excerpt: "The newly renovated STEM facility features cutting-edge technology and collaborative spaces.",
                content: "The newly renovated STEM facility features cutting-edge technology and collaborative spaces.",
                permalink: "#",
                likes: 32,
                comments: 7,
                shares: 5,
                image: "/placeholder.svg"
            },
            {
                id: "sample-3",
                date: "NOV",
                year: "2024",
                title: "Annual Winter Concert Features Student Orchestra",
                category: "Arts & Culture",
                excerpt: "Join us for an evening of beautiful music as our talented student musicians perform.",
                content: "Join us for an evening of beautiful music as our talented student musicians perform.",
                permalink: "#",
                likes: 28,
                comments: 15,
                shares: 3,
                image: "/placeholder.svg"
            }
        ];
        hasMore = false;
        nextCursor = undefined;
    }
} catch (err) {
    console.error("Error fetching Facebook posts for news page:", err);
    // Show fallback posts on error
    posts = [
        {
            id: "fallback-1",
            date: "DEC",
            year: "2024",
            title: "Welcome to Our News Section",
            category: "General News",
            excerpt: "Stay tuned for the latest updates and announcements from our school community.",
            content: "Stay tuned for the latest updates and announcements from our school community.",
            permalink: "#",
            likes: 0,
            comments: 0,
            shares: 0,
            image: "/placeholder.svg"
        }
    ];
    hasMore = false;
    nextCursor = undefined;
    error = "Unable to load Facebook posts at this time.";
}
---

<CollegeLayout title="School News">
    <section class="border-b border-border/40">
        <div class="container mx-auto px-6 lg:px-12 max-w-6xl py-16 lg:py-24">
            <a
                href="/"
                class="inline-flex items-center gap-2 text-muted-foreground hover:text-foreground mb-12 transition-colors group"
            >
                <ArrowLeft
                    className="w-4 h-4 group-hover:-translate-x-1 transition-transform"
                />
                <span class="text-sm tracking-wide">Back to Home</span>
            </a>

            <div class="max-w-3xl">
                <h1
                    class="font-serif text-5xl lg:text-7xl text-foreground mb-6 text-balance leading-tight"
                >
                    School News
                </h1>
                <p
                    class="text-lg lg:text-xl text-muted-foreground leading-relaxed text-pretty"
                >
                    Stay informed with the latest stories, achievements, and
                    updates from our vibrant school community.
                </p>
            </div>
        </div>
    </section>

    <section class="py-12 lg:py-20">
        <div class="container mx-auto px-6 lg:px-12 max-w-6xl">
            <div id="news-container" class="space-y-1">
                {
                    posts.length === 0 ? (
                        <div class="text-center py-16">
                            <h2 class="text-2xl font-serif text-foreground mb-4">
                                No Data Found
                            </h2>
                            <p class="text-muted-foreground">
                                {error || "No news articles are available at this time. Please check back later."}
                            </p>
                        </div>
                    ) : (
                        posts.map((post) => (
                            <a
                                href={`/news/${post.id}`}
                                class="group block border-b border-border/40 last:border-b-0 py-8 lg:py-12 hover:bg-muted/30 transition-all duration-300 -mx-6 px-6 lg:-mx-12 lg:px-12"
                            >
                                <div class="grid lg:grid-cols-[180px_200px_1fr_auto] gap-6 lg:gap-8 items-start">
                                    {/* Date Column */}
                                    <div class="flex flex-col gap-2">
                                        <time class="text-sm tracking-wider text-muted-foreground uppercase font-medium">
                                            {post.date}, {post.year}
                                        </time>
                                        <span class="inline-block px-3 py-1 text-xs font-medium rounded-full bg-secondary/10 text-secondary w-fit">
                                            {post.category}
                                        </span>
                                    </div>

                                    {/* Image Column */}
                                    {post.image && (
                                        <div class="relative aspect-[4/3] rounded-lg overflow-hidden bg-muted/20 hidden lg:block">
                                            <img
                                                src={post.image}
                                                alt={post.title}
                                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                            />
                                            <div class="absolute inset-0 bg-gradient-to-r from-background/60 via-background/20 to-transparent opacity-40 group-hover:opacity-20 transition-opacity duration-300" />
                                            <div class="absolute inset-0 bg-gradient-to-t from-background/80 via-transparent to-transparent" />
                                        </div>
                                    )}

                                    {/* Content Column */}
                                    <div class="space-y-4">
                                        <h2 class="font-serif text-2xl lg:text-4xl text-foreground leading-tight group-hover:text-secondary transition-colors text-balance">
                                            {post.title}
                                        </h2>
                                        <p class="text-base lg:text-lg text-muted-foreground leading-relaxed text-pretty">
                                            {post.excerpt}
                                        </p>
                                        <div class="flex items-center gap-4 text-sm text-muted-foreground pt-2">
                                            <span>{post.likes} likes</span>
                                            <span>•</span>
                                            <span>
                                                {post.comments} comments
                                            </span>
                                            <span>•</span>
                                            <span>{post.shares} shares</span>
                                        </div>
                                    </div>

                                    {/* Arrow Column */}
                                    <div class="hidden lg:flex items-center justify-center">
                                        <div class="w-12 h-12 rounded-full border border-border group-hover:border-secondary group-hover:bg-secondary/5 flex items-center justify-center transition-all">
                                            <ArrowRight className="w-5 h-5 text-muted-foreground group-hover:text-secondary group-hover:translate-x-1 transition-all" />
                                        </div>
                                    </div>
                                </div>
                            </a>
                        ))
                    )
                }
            </div>

            {/* Load More Button */}
            {
                hasMore && (
                    <div
                        class="flex justify-center mt-16"
                        id="load-more-container"
                    >
                        <button
                            type="button"
                            class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-secondary/10 hover:bg-secondary/20 text-secondary font-medium transition-colors"
                            data-cursor={nextCursor}
                        >
                            Load More News
                            <ArrowRight className="w-4 h-4" />
                        </button>
                    </div>
                )
            }
        </div>
    </section>

    <script>
        // Enhanced load more functionality with better error handling
        const loadMoreContainer = document.getElementById("load-more-container");
        const newsContainer = document.getElementById("news-container");

        if (loadMoreContainer && newsContainer) {
            const loadMoreButton = loadMoreContainer.querySelector("button");
            if (loadMoreButton) {
                loadMoreButton.addEventListener("click", async () => {
                    const cursor = loadMoreButton.dataset.cursor;
                    if (!cursor) return;

                    loadMoreButton.disabled = true;
                    loadMoreButton.innerHTML = "Loading...";

                    try {
                        // Fetch more Facebook posts using server-side API
                        console.log('Load More: Fetching posts with cursor:', cursor);

                        const params = new URLSearchParams({
                            limit: '5',
                            after: cursor
                        });

                        const response = await fetch(`/api/facebook-posts?${params.toString()}`);

                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('Load More: Response:', data);

                        if (data.posts && data.posts.length > 0) {
                            // Remove "no data" message if it exists
                            const noDataMessage = newsContainer.querySelector('.text-center');
                            if (noDataMessage) {
                                noDataMessage.remove();
                            }

                            // Create and append new post elements
                            data.posts.forEach((post) => {
                                const template = document.createElement("template");
                                template.innerHTML = `
                                    <a href="/news/${post.id}" class="group block border-b border-border/40 last:border-b-0 py-8 lg:py-12 hover:bg-muted/30 transition-all duration-300 -mx-6 px-6 lg:-mx-12 lg:px-12">
                                        <div class="grid lg:grid-cols-[180px_200px_1fr_auto] gap-6 lg:gap-8 items-start">
                                            <div class="flex flex-col gap-2">
                                                <time class="text-sm tracking-wider text-muted-foreground uppercase font-medium">
                                                    ${post.date}, ${post.year}
                                                </time>
                                                <span class="inline-block px-3 py-1 text-xs font-medium rounded-full bg-secondary/10 text-secondary w-fit">
                                                    ${post.category}
                                                </span>
                                            </div>
                                            ${post.image ? `
                                                <div class="relative aspect-[4/3] rounded-lg overflow-hidden bg-muted/20 hidden lg:block">
                                                    <img src="${post.image}" alt="${post.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                                                    <div class="absolute inset-0 bg-gradient-to-r from-background/60 via-background/20 to-transparent opacity-40 group-hover:opacity-20 transition-opacity duration-300"></div>
                                                    <div class="absolute inset-0 bg-gradient-to-t from-background/80 via-transparent to-transparent"></div>
                                                </div>
                                            ` : ''}
                                            <div class="space-y-4">
                                                <h2 class="font-serif text-2xl lg:text-4xl text-foreground leading-tight group-hover:text-secondary transition-colors text-balance">
                                                    ${post.title}
                                                </h2>
                                                <p class="text-base lg:text-lg text-muted-foreground leading-relaxed text-pretty">
                                                    ${post.excerpt}
                                                </p>
                                                <div class="flex items-center gap-4 text-sm text-muted-foreground pt-2">
                                                    <span>${post.likes} likes</span>
                                                    <span>•</span>
                                                    <span>${post.comments} comments</span>
                                                    <span>•</span>
                                                    <span>${post.shares} shares</span>
                                                </div>
                                            </div>
                                            <div class="hidden lg:flex items-center justify-center">
                                                <div class="w-12 h-12 rounded-full border border-border group-hover:border-secondary group-hover:bg-secondary/5 flex items-center justify-center transition-all">
                                                    <svg class="w-5 h-5 text-muted-foreground group-hover:text-secondary group-hover:translate-x-1 transition-all" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M5 12h14M12 5l7 7-7 7"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                `;

                                const newPost = template.content.firstElementChild;
                                if (newPost) {
                                    newsContainer.appendChild(newPost);
                                }
                            });

                            // Update button state
                            if (data.hasNext && data.nextCursor) {
                                loadMoreButton.dataset.cursor = data.nextCursor;
                                loadMoreButton.innerHTML = `Load More News <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M5 12h14M12 5l7 7-7 7"/></svg>`;
                                loadMoreButton.disabled = false;
                            } else {
                                // No more posts to load
                                loadMoreContainer.remove();
                            }
                        } else {
                            // No posts returned - show message
                            const noMorePosts = document.createElement("div");
                            noMorePosts.className = "text-center py-8 text-muted-foreground";
                            noMorePosts.textContent = "No more articles to load.";
                            newsContainer.appendChild(noMorePosts);
                            loadMoreContainer.remove();
                        }
                    } catch (error) {
                        console.error("Error loading more posts:", error);
                        loadMoreButton.innerHTML = "Error loading posts";

                        // Show error message
                        const errorMessage = document.createElement("div");
                        errorMessage.className = "text-center py-8 text-red-500";
                        errorMessage.textContent = "Failed to load more posts. Please try again.";
                        newsContainer.appendChild(errorMessage);

                        // Try again after 3 seconds
                        setTimeout(() => {
                            if (loadMoreContainer && loadMoreButton) {
                                loadMoreButton.innerHTML = `Load More News <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M5 12h14M12 5l7 7-7 7"/></svg>`;
                                loadMoreButton.disabled = false;
                                // Remove error message
                                errorMessage.remove();
                            }
                        }, 3000);
                    }
                });
            }
        }
    </script>
</CollegeLayout>
